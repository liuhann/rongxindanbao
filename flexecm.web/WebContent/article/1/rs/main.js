define("main",["./lib/backbone","./lib/underscore","./lib/jquery","./app/HomeApp","./util/State","./model/StateModel","./model/BaseModel","./util/UserAgent","./util/Dispatch","./view/FitSizeView","./view/SingleNoteContainer","./template/Home","./util/Template","./lib/mustache","./util/DateUtil","./view/WebSingleNote","./view/NoteContentView","./template/NoteContent","./template/RemindPanel","./template/NoteContentTitle","./view/NoteContentInfoView","./template/NoteContentInfo","./view/MobileSingleNote","./util/PopTips","./model/UserModel","./util/Api","./util/Cookie","./util/localStorage","./template/AppButton","./model/NoteCollection","./model/BaseCollection","./model/SharedNoteModel","./view/NavView","./template/Nav","./view/Dialog/SaveToDialogView","./view/DialogView","./template/Dialog","./template/SaveToDialog","./view/SaveToTipsView","./template/SaveToTips","./view/Dialog/LoginDialogView","./template/LoginDialog","./template/LoginTips","./util/Passport","./view/NoteBookContainer","./view/MobileNoteBook","./template/NoteList","./view/NoteListView","./view/NoteList/SnapNoteListView","./view/NoteList/BaseNoteListView","./template/SnapNoteList","./view/NoteList/SnapNoteView","./view/NoteList/BaseNoteView","./template/SnapNote","./view/NavBack","./template/NavBack","./util/PathUtil","./view/WebNoteBook"],function(e){e("./lib/backbone");var t=e("./app/HomeApp"),i=e("./util/Dispatch"),n=e("./util/PathUtil"),o=e("./model/UserModel"),s=e("./util/Cookie"),l=e("./lib/jquery"),a=new t,r=!!l.browser.msie,c=parseInt(l.browser.version);if(s.get("YNOTE_CSTK")||l.ajax({url:"/yws/mapi/user?keyfrom=web&method=get",cache:!1,type:"GET"}),l.ajaxPrefilter(function(e){if(e.url&&e.contentType&&/(?:yws)/i.test(e.url)&&!(/(?:\/yws\/mapi\/user\?method=get)/i.test(e.url)||/(?:\/yws\/mapi\/user\?method=register)/i.test(e.url)||/(?:\/yws\/mapi\/user\?method=edm)/i.test(e.url)||/(?:\/yws\/mapi\/res)/i.test(e.url)||/(?:\/yws\/mapi\/ad)/i.test(e.url)||/(?:\/yws\/mapi\/payment)/i.test(e.url)||/(?:\/yws\/mapi\/ilogrpt)/i.test(e.url)||/(?:\/yws\/public)/i.test(e.url)||/(?:\/yws\/mapi\/weibo\/share)/i.test(e.url)))if(/(?:x-www-form-urlencoded)/i.test(e.contentType))e.data?e.data+="&cstk="+s.get("YNOTE_CSTK"):e.data="cstk="+s.get("YNOTE_CSTK");else if(/(?:json)/i.test(e.contentType)){if(e.data){var t=JSON.parse(e.data);t.cstk=s.get("YNOTE_CSTK"),e.data=JSON.stringify(t)}}else e.data&&"string"==typeof e.data?e.data+="&cstk="+s.get("YNOTE_CSTK"):e.data="cstk="+s.get("YNOTE_CSTK")}),r&&8>c)i.To.legacyNavigator();else{var u=n.getArguments();u&&u.type&&u.id?(o.persistLogin(),a.run(u)):i.To.error()}}),define("lib/backbone",["lib/underscore","lib/jquery"],function(e){var t=window.Backbone,i=e("lib/underscore"),n=e("lib/jquery"),o=t.sync;return t.sync=function(e,t,s){t&&t.toApiJSON&&"string"!=typeof s.data&&(s=s||{},s.data=n.param(i.extend({},s.data,t.toApiJSON()))),o.call(this,e,t,s)},t.noConflict()}),define("lib/underscore",[],function(){var e=window._;return e.until=function(t,i,n){n=n||50;var o=e.debounce(function(){t.apply(this)?i.apply(this,arguments):o.apply(this,arguments)},n);return o},e.noConflict()}),define("lib/jquery",[],function(){return jQuery.noConflict()}),define("app/HomeApp",["lib/backbone","lib/underscore","lib/jquery","util/State","model/StateModel","model/BaseModel","util/UserAgent","util/Dispatch","view/FitSizeView","view/SingleNoteContainer","template/Home","util/Template","lib/mustache","util/DateUtil","view/WebSingleNote","view/NoteContentView","template/NoteContent","template/RemindPanel","template/NoteContentTitle","view/NoteContentInfoView","template/NoteContentInfo","view/MobileSingleNote","util/PopTips","model/UserModel","util/Api","util/Cookie","util/localStorage","template/AppButton","model/NoteCollection","model/BaseCollection","model/SharedNoteModel","view/NavView","template/Nav","view/Dialog/SaveToDialogView","view/DialogView","template/Dialog","template/SaveToDialog","view/SaveToTipsView","template/SaveToTips","view/Dialog/LoginDialogView","template/LoginDialog","template/LoginTips","util/Passport","view/NoteBookContainer","view/MobileNoteBook","template/NoteList","view/NoteListView","view/NoteList/SnapNoteListView","view/NoteList/BaseNoteListView","template/SnapNoteList","view/NoteList/SnapNoteView","view/NoteList/BaseNoteView","template/SnapNote","view/NavBack","template/NavBack","util/PathUtil","view/WebNoteBook"],function(e){var t=e("lib/backbone"),i=e("lib/underscore"),n=e("lib/jquery"),o=function(){this.initialize()};return i.extend(o.prototype,t.Events,{currentPage:null,initialize:function(){this.pages={},this.state=e("util/State").getInstance()},run:function(t){this.options=t,window.abTest=parseInt(10*Math.random(),10)%2,window.abTest?window._hmt.push(["_trackEvent","mobile","abTest-top"]):window._hmt.push(["_trackEvent","mobile","abTest-bottom"]);var i=this.options.type.toLowerCase();"note"===i?this.pageLoader("showNote"):"notebook"===i?this.pageLoader("listNote"):e("util/Dispatch").To.error()},pageLoader:function(e){this.state.set(this.options),n("#nw_loading").remove(),this[e]()},getOrInitialitePage:function(t){var i=t.name,n=t.PageClass;return this.pages[i]||(this.pages[i]=new n({el:document.getElementById("wrap")}),this.pages[i].render(),e("view/FitSizeView").getInstance().fitSize(!0)),this.pages[i]},showNote:function(){this.getOrInitialitePage({name:"showNote",PageClass:e("view/SingleNoteContainer")})},listNote:function(){this.getOrInitialitePage({name:"listNote",PageClass:e("view/NoteBookContainer")})}}),o}),define("util/State",["model/StateModel","model/BaseModel","lib/backbone","lib/underscore","lib/jquery","util/UserAgent","util/Dispatch"],function(e,t){var i=e("model/StateModel");e("lib/underscore"),e("lib/backbone");var n=null;t.getInstance=function(){return null===n&&(n=new i),n}}),define("model/StateModel",["model/BaseModel","lib/backbone","lib/underscore","lib/jquery","util/UserAgent","util/Dispatch"],function(e){var t=e("model/BaseModel");e("lib/underscore");var i=e("util/UserAgent"),n=t.extend({initialize:function(){t.prototype.initialize.apply(this,arguments)},setNoteCollection:function(e){e.on("reset",this.onNoteReset,this)},changeNote:function(e){this.set({note:e},{silent:!0}),this.trigger("change:note",this,e)},selectNoteAndChangeNoteId:function(e,t){var i=t.id;this.changeNote(i)},onNoteReset:function(t){var n=this.get("note"),o=t.get(n);return o?(this.changeNote(n),void 0):(0===t.length&&e("util/Dispatch").To.blank(),i.isMobile||this.selectNoteAndChangeNoteId(t,t.first()),void 0)}});return n}),define("model/BaseModel",["lib/backbone","lib/underscore","lib/jquery"],function(e){var t=e("lib/backbone"),i=e("lib/underscore"),n=e("lib/jquery"),o=t.Model.extend({api:null,convertAlias:function(e){return this._convert(e,this.api.aliasReverse)},parse:function(e){return e=t.Model.prototype.parse.apply(this,arguments),this.convertAlias(e)},_convert:function(e,t){var o={};return i.each(e,function(e,i){t[i]&&(n.isPlainObject(e)?e=this._convert(e,t):n.isArray(e)&&e.forEach(function(i,n){e[n]=this._convert(i,t)},this),null!==e&&(o[t[i]]=e))}.bind(this)),o}});return o}),define("util/UserAgent",[],function(e,t){var i=navigator.userAgent,n=/(?:ipad|iphone)/i.test(i),o=/(?:android)/i.test(i),s=/(?:micromessenger)/i.test(i),l=/(?:windows phone)/i.test(i)||/(?:wpdesktop)/i.test(i)||/(?:wp7)/i.test(i),a=/(?:yixin)/i.test(i);t.isMobile=n||o||l||s||a,t.isIOS=n,t.isAndroid=o,t.isWeixin=s,t.isWindowPhone=l,t.isYiXin=a}),define("util/Dispatch",[],function(e,t){t.To={error:function(){window.top.location.href="/share/error.html"},blank:function(){window.top.location.href="/share/blank.html"},legacyNavigator:function(){window.top.location.href="/share/upgrade.html"}}}),define("view/FitSizeView",["lib/backbone","lib/underscore","lib/jquery","util/UserAgent","util/State","model/StateModel","model/BaseModel","util/Dispatch"],function(e){var t=e("lib/backbone"),i=e("lib/underscore"),n=e("lib/jquery"),o=t.View.extend({initialize:function(){this.fitSize=function(){}},bindEvent:function(){n(window).on("resize",this.onResizeFitSize)},rebuildElementSet:function(){this.$list=n(".fit-size"),this.blk_sidebar=n(".blk-sidebar")},fitSizeImmediately:function(t){var o=e("util/UserAgent");if(!o.isIOS){t&&this.rebuildElementSet();var s,l=e("util/State").getInstance();"note"===l.get("type")?(s=n(".blk-mid").width(),this.blk_sidebar.css("right",(s-n(".blk-main").width())/2+40)):(this.$list.each(function(){var e=n(this),t=e.siblings(".fit-size-sibling:visible"),o=i.reduce(t,function(e,t){return e+n(t).outerHeight(!0)},0);-1===e[0].className.indexOf("list-wrp-snap")&&e.height(e.parent().height()-o)}),s=n(".blk-mid").width(),this.blk_sidebar.css("right",(s-n(".blk-main").width())/2))}},onResizeFitSize:function(){this.fitSize()}}),s=null;return{getInstance:function(){return null===s&&(s=new o),s}}}),define("view/SingleNoteContainer",["lib/backbone","lib/underscore","lib/jquery","util/UserAgent","template/Home","util/Template","lib/mustache","util/DateUtil","view/WebSingleNote","view/NoteContentView","template/NoteContent","template/RemindPanel","template/NoteContentTitle","view/NoteContentInfoView","template/NoteContentInfo","util/State","model/StateModel","model/BaseModel","util/Dispatch","view/FitSizeView","view/MobileSingleNote","util/PopTips","model/UserModel","util/Api","util/Cookie","util/localStorage","template/AppButton","model/NoteCollection","model/BaseCollection","model/SharedNoteModel","view/NavView","template/Nav","view/Dialog/SaveToDialogView","view/DialogView","template/Dialog","template/SaveToDialog","view/SaveToTipsView","template/SaveToTips","view/Dialog/LoginDialogView","template/LoginDialog","template/LoginTips","util/Passport","view/FitSizeView"],function(e){var t=e("lib/backbone"),i=e("lib/underscore"),n=e("util/UserAgent"),o=e("lib/jquery"),s=t.View.extend({template:e("template/Home"),className:"hide",initialize:function(){var t=e("view/WebSingleNote"),i=e("view/MobileSingleNote");n.isMobile?this.note=i.getInstance():(this.note=t.getInstance(),this.bindScroll());var o=e("model/SharedNoteModel");this.state=e("util/State").getInstance(),this.shareKey=this.state.get("id"),this.noteModel=new o;var s=e("view/NavView");this.nav=new s},render:function(){this.el.innerHTML=this.template.render({isMobile:n.isMobile,isSingleNote:!0}),this.nav.render(),this.$top=this.$(".blk-top"),this.$top.append(this.nav.el),this.note.render(),this.$main=this.$(".blk-main"),this.$main.append(this.note.el),this.$el.addClass("single-note"),this.noteModel&&this.renderModel()},renderModel:function(){var t=e("model/SharedNoteModel");this.noteModel.fetch({success:function(){t.setModel(this.noteModel);var i=this.noteModel.get("title")||"无标题笔记";document.title=i,this.note.setModel(this.noteModel),this.$el.removeClass("hide"),e("view/FitSizeView").getInstance().fitSize(!0)}.bind(this),error:function(){e("util/Dispatch").To.error()}})},bindScroll:function(){o(document.body).on("DOMMouseScroll mousewheel",i.throttle(i.bind(function(e){var t=e.originalEvent,i=t.detail?-120*t.detail:t.wheelDelta,n=this.note.$el.scrollTop(),s=o(e.target);(s.is(".blk-main")||s.is(".blk-mid"))&&this.note.$el.scrollTop(n+(i>0?-100:100))},this),10))}});return s}),define("template/Home",["util/Template","lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("util/Template"),i={};return i.tpl='<div class="blk-top fit-size-sibling"></div>\n<div class="blk-mid fit-size">\n    <div class="blk-main">\n    </div>\n</div>',new t(i.tpl)}),define("util/Template",["lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("lib/jquery"),i=e("lib/mustache"),n=e("lib/underscore"),o={_formatTime:function(){var t=e("util/DateUtil");return function(e,i){var n=parseInt(i(e),10);return isNaN(n)?"":t.formatTimestamp(n,{isWithTime:!0})}},_formatDate:function(){var t=e("util/DateUtil");return function(e,i){var n=parseInt(i(e),10);return isNaN(n)?"":t.formatTimestamp(n,{isWithTime:!1})}},_formatFileSize:function(){return function(e,t){for(var i=parseInt(t(e),10),n=["B","KB","MB","GB","TP","PB","EB"],o=0,s=0,l=n.length;i>1&&l>s;)o=Math.round(100*i,10)/100+n[s],i/=1024,s+=1;return o}}},s=function(e){this.text=e};return s.prototype.render=function(e){return i.to_html(this.text,n.extend({},e,o))},s.preload=function(e){var i=null;return t.ajax({type:"GET",async:!1,url:"template/"+e,success:function(e){i=e},dataType:"text"}),new s(i)},s}),define("lib/mustache",[],function(){return Mustache}),define("util/DateUtil",["lib/underscore"],function(e){var t=e("lib/underscore"),i={formatTimestamp:function(e,t){var i=new Date(e);2e3>i.getFullYear()&&(i=new Date(1e3*e));var n=i.getMinutes();10>n&&(n="0"+n);var o=i.getFullYear()+"-"+(i.getMonth()+1)+"-"+i.getDate();return t&&t.isWithTime&&(o+=" "+i.getHours()+":"+n),o}};return i.formatTimestamp=t.memoize(i.formatTimestamp),i}),define("view/WebSingleNote",["lib/backbone","lib/underscore","lib/jquery","view/NoteContentView","util/UserAgent","template/NoteContent","util/Template","lib/mustache","util/DateUtil","template/RemindPanel","template/NoteContentTitle","view/NoteContentInfoView","template/NoteContentInfo","util/State","model/StateModel","model/BaseModel","util/Dispatch","view/FitSizeView"],function(e){var t=e("lib/backbone");e("lib/underscore"),e("lib/jquery");var i=t.View.extend({className:"blk-note",isModelRendered:!1,model:null,isFirstLoad:!0,initialize:function(){var t=e("view/NoteContentView");this.content=t.getInstance(),this.state=e("util/State").getInstance(),this.state.on("change:note",this.onNoteChange,this)},render:function(){this.$el.append(this.content.el),this.content.render(),this.model&&this.setModel(this.model)},setData:function(e){this.collection=e},setModel:function(e){e!==this.model&&(this.model=e,this.isModelRendered=!0,this.content.setModel(this.model))},getNoteFromState:function(){var e=this.state.get("note");return this.collection.get(e)},onNoteChange:function(e,t){if(null===t||"note"===this.state.get("type"))return this.$el.hide(),void 0;this.$el.show();var i=this.getNoteFromState();this.setModel(i)}}),n=null;return{getInstance:function(){return null===n&&(n=new i),n}}}),define("view/NoteContentView",["lib/backbone","lib/underscore","lib/jquery","util/UserAgent","template/NoteContent","util/Template","lib/mustache","util/DateUtil","template/RemindPanel","template/NoteContentTitle","view/NoteContentInfoView","template/NoteContentInfo","util/State","model/StateModel","model/BaseModel","util/Dispatch","view/FitSizeView"],function(e){var t=e("lib/backbone"),i=e("lib/jquery"),n=e("lib/underscore"),o=e("util/UserAgent"),s=t.View.extend({className:"blk-bd",events:{"click [data-path]":"bindAttachmentEvent","click a":"setLinkOpenMode"},isModelRendered:!1,template:e("template/NoteContent"),remindTemplate:e("template/RemindPanel"),contentTitleTemplate:e("template/NoteContentTitle"),model:null,isFirstLoad:!0,contentDivLoaded:!1,isModelRendered:!1,initialize:function(){t.View.prototype.initialize.apply(this,arguments);var i=e("view/NoteContentInfoView");this.noteInfo=i.getInstance(),this.renderModel=n.until(this.isContentDivLoaded.bind(this),this.renderModel.bind(this)),this.state=e("util/State").getInstance()},render:function(){this.el.innerHTML=this.template.render(),this.$el.append(this.noteInfo.el),this.$content=i('<div class="note-content"></div>'),this.$el.append(this.$content),this.contentDivLoaded=!0,this.$title=this.$(".note-title-text"),this.$titleInput=this.$(".note-title-input"),this.$notebookTitle=this.$(".notebook-title-text"),this.$lastModified=this.$(".save-tip"),this.model&&this.setModel(this.model);var e=!0;this.switchNoteInfo(e)},setCollection:function(e){this.collection=e},getExpandBtn:function(){var e=this.$(".expand-btn");return e.length||(e=this.$(".expand-btn-wrapper")),e},setModel:function(e){if(this.model===e)return this.renderModel(),void 0;this.model=e;var t="note"===this.state.get("type");return this.noteInfo.setModel(this.model),t?(this.renderModel(),void 0):(this.model.fetch({success:function(){this.trigger("modelLoaded"),this.renderModel()}.bind(this)}),void 0)},processRemind:function(e){var t=i(e).find("input"),n={};return n.checked="true"===t.attr("data-attr-checked")?!0:!1,n.remind="true"===t.attr("data-attr-remind")?!0:!1,n.content=t.attr("data-attr-content"),this.remindTemplate.render(n)},renderModel:function(){var e=this.model.toJSON();e.title=e.title||"无标题笔记",this.collection&&this.collection.title&&(e.shareTitle=this.collection.title),e.isMobile=o.isMobile,this.$(".note-title").html(this.contentTitleTemplate.render(e)),this.isModelRendered=!0;var t=this.getEditorRenderData();this.$content.html(t),i.each(this.$content.find('img[data-media-type="image"]'),function(e,t){t.style.height="auto"});var n=this.$content.find('img[src="DEFAULTIMAGE"]');i.each(n,function(e,t){t.setAttribute("src","style/images/unknown.png")}),i.each(this.$content.find(".remind-outer"),function(e,t){4===i(t).text().length?t.innerHTML=this.processRemind(t):i(t).find("input").replaceWith(this.processRemind(t))}.bind(this)),i.each(this.$content.find('input[data-media-type="todo"]'),function(e,t){var n=i('<div class="remind-outer"></div>');i(t).clone().appendTo(n),n.html(this.processRemind(n)),i(t).replaceWith(n[0])}.bind(this)),i.each(this.$content.find("table"),function(e,t){t.style.width="auto"}),this.$content.find("style").remove()},isContentDivLoaded:function(){return this.contentDivLoaded},getEditorRenderData:function(){var e=this.model.get("byteStream");return e=e.replace(/ path(?=(=".+?".+?>))/gi," data-path")},bindAttachmentEvent:function(e){var t=e.currentTarget,i=t.getAttribute("data-path");i&&i.length&&(i=i+(-1===i.indexOf("?")?"?":"&")+"keyfrom=public",window.open(i))},setLinkOpenMode:function(e){var t=e.target,n="a"===t.tagName.toLowerCase()?i(t):i(t).parents("a");n.length>0&&n.attr("target","_blank")},getExpandBtn:function(){var e=this.$(".expand-btn");return e.length||(e=this.$(".expand-btn-wrapper")),e},switchNoteInfo:function(t){var i=this.$(this.noteInfo.el),n=this.getExpandBtn(),s=o.isMobile,l=function(){e("view/FitSizeView").getInstance().fitSize(!0)};t?(this.isFirstLoad?(i.css("display","block"),l()):s?i.css("display","block"):i.slideDown("fast",l),n.addClass("expand")):(s?i.css("display","none"):i.slideUp("fast",l),n.removeClass("expand")),this.isFirstLoad=!1}}),l=null;return{getInstance:function(){return null===l&&(l=new s),l}}}),define("template/NoteContent",["util/Template","lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("util/Template"),i={};return i.tpl='<div class="note-title">\n</div>',new t(i.tpl)}),define("template/RemindPanel",["util/Template","lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("util/Template"),i={};return i.tpl='<div class="remind-content view-mode {{^remind}} expired{{/remind}} {{#checked}} invalid{{/checked}}" contentEditable="false" data-remind-data={{remindData}} title="添加到我的笔记后可以编辑待办事项">\n    <div class="remind-checked {{#checked}} checked{{/checked}}" title="添加到我的笔记后可以编辑待办事项">\n            <i class="icon-check"></i>\n    </div>\n    <i class="remind-watch" title="添加到我的笔记后可以编辑待办事项"></i>\n    <span class="remind-text" title="{{content}}">{{content}}</span>\n</div>',new t(i.tpl)}),define("template/NoteContentTitle",["util/Template","lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("util/Template"),i={};return i.tpl='<p class="note-title-text">{{title}}</p>\n',new t(i.tpl)}),define("view/NoteContentInfoView",["lib/backbone","lib/underscore","lib/jquery","util/UserAgent","template/NoteContentInfo","util/Template","lib/mustache","util/DateUtil"],function(e){var t=e("lib/backbone");e("lib/underscore"),e("lib/jquery");var i=e("util/UserAgent"),n=t.View.extend({className:"blk-expand meta fit-size-sibling",expanded:null,template:e("template/NoteContentInfo"),initialize:function(){},getRenderData:function(){if(!this.model)return null;var e=this.model.toJSON();return e.sourceUrlWithProtocol=e.sourceUrl&&0!==e.sourceUrl.indexOf("http")?"http://"+e.sourceUrl:e.sourceUrl,e},render:function(){var e=this.getRenderData();e.isMobile=i.isMobile,this.el.innerHTML=this.template.render(e)},setModel:function(e){this.model=e,this.render()},onModelChange:function(){this.render()}}),o=null;return{getInstance:function(){return null===o&&(o=new n),o}}}),define("template/NoteContentInfo",["util/Template","lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("util/Template"),i={};return i.tpl='<div class="meta-info">\n    <span class="meta-item">\n        <span class="meta-create meta-col">\n            <i></i>\n            <span>创建时间：</span>\n            {{#_formatTime}}{{createTime}}{{/_formatTime}}\n        </span>\n    </span>\n{{^isMobile}}\n    <span class="meta-item">\n        <span class="meta-update meta-col">\n            <i></i>\n            <span>修改时间：</span>\n            {{#_formatTime}}{{modifyTime}}{{/_formatTime}}\n        </span>\n    </span>\n    <span class="meta-item">\n        <span class="meta-via meta-col form {{^sourceUrl}}empty{{/sourceUrl}}">\n            <i></i>\n            <span>来源：</span>\n            <a class="value" href="{{sourceUrlWithProtocol}}" target="_blank" title="打开链接">\n                {{sourceUrl}}\n            </a>\n        </span>\n    </span>\n{{/isMobile}}\n{{#isMobile}}\n    <span class="meta-item">\n        <span class="meta-via meta-col form {{^sourceUrl}}empty{{/sourceUrl}}">\n            <i></i>\n            <span>来源：</span>\n            <a class="value" href="{{sourceUrlWithProtocol}}" target="_blank" title="打开链接">{{sourceUrl}}\n            </a>\n        </span>\n    </span>\n{{/isMobile}}\n</div>\n',new t(i.tpl)}),define("view/MobileSingleNote",["lib/backbone","lib/underscore","lib/jquery","util/UserAgent","util/PopTips","model/UserModel","util/Api","util/Cookie","util/State","model/StateModel","model/BaseModel","util/Dispatch","util/localStorage","template/AppButton","util/Template","lib/mustache","util/DateUtil","template/RemindPanel","view/NoteContentView","template/NoteContent","template/NoteContentTitle","view/NoteContentInfoView","template/NoteContentInfo","view/FitSizeView","model/NoteCollection","model/BaseCollection","model/SharedNoteModel"],function(e){var t=e("lib/backbone");e("lib/underscore"),e("util/UserAgent");var i=e("lib/jquery"),n=e("util/PopTips"),o=e("model/UserModel"),s=e("util/localStorage"),l="https://note.youdao.com/oauth/login_mobile.html",a="1213",r=t.View.extend({className:"blk-note",events:{"click .expand-btn,.expand-btn-wrapper":"onExpandClick","click #copyToMyNote .active":"onClickSaveTo","click #downloadBtn":"onClickDownload","click #logoutUser":"onClickLogout","click .remind-checked":"onClickCheck","click .remind-watch":"onClickCheck","click .praise-icon":"onClickPraise"},isModelRendered:!1,isLogin:!1,model:null,isFirstLoad:!0,appButtonTemplate:e("template/AppButton"),remindTemplate:e("template/RemindPanel"),initialize:function(){var t=e("view/NoteContentView");this.content=t.getInstance(),this.state=e("util/State").getInstance(),this.state.on("change:note",this.onNoteChange,this),n.setPopTips(),n.setWxTips()},render:function(){this.$el.append(this.content.el),this.$div=i("<div></div>").addClass("note-content-wrapper mobile-wrapper"),this.$el.append(this.$div),i("#wrap").addClass("mobile-wrap"),this.content.render(),this.model&&this.setModel(this.model)},getExpandBtn:function(){var e=this.$(".expand-btn");return e.length||(e=this.$(".expand-btn-wrapper")),e},setData:function(e){this.collection=e},setModel:function(e){e!==this.model&&(this.model=e,this.appendButton(),this.resizeObject(),this.content.setModel(this.model),this.isModelRendered=!0)},getNoteFromState:function(){var e=this.state.get("note");return this.collection.get(e)},onExpandClick:function(e){e.preventDefault()},onNoteChange:function(e,t){if(null===t||"note"===this.state.get("type"))return this.$el.hide(),void 0;this.$el.show();var i=this.getNoteFromState();this.setModel(i)},appendButton:function(){var e=this.$div,t=s.get("praise-"+this.model.id);t="null"!=t&&"undefined"!=t&&t?!0:!1,o.fetchUsermeta({success:function(){this.isLogin=!0}.bind(this),error:function(){this.isLogin=!1}.bind(this),complete:function(){var i=this.$el;e.append(this.appButtonTemplate.render({clicked:t,isLogin:this.isLogin,notePv:this.model.attributes.pv,praiseNum:this.model.attributes.praise,isAd:window.abTest})),window.abTest||(window.yd_slot_id=a,i.find(".ad").attr("id","yd_slot_id_"+a),setTimeout(function(){var e=document.createElement("script");e.src="http://impservice.union.youdao.com/imp/js/commonAd.js",i.find(".bottom-pr-link").append(e)},100))}.bind(this)})},showSaveDialog:function(){o.getUserNotebooks({success:function(){this.$saveBtn.html("正在保存中..."),this.$saveBtn.removeClass("active"),this.$saveBtn.addClass("inactive"),e("util/State").getInstance(),o.fetchUsermeta({success:function(){var e=this.model.id,t=o.getUserDefaultNotebook(),i=document.title;o.saveToUserNotebook(e,t,i),o.on("saveSuccess",this.onSaveSuccess,this),o.on("saveFail",this.onSaveFail,this)}.bind(this)})}.bind(this),authFail:function(){var e=location.href;this.state.get("copy")||(e+="&copy=click"),location.href=l+"?back_url="+encodeURIComponent(e)}.bind(this),error:function(){n.showPopTips("保存失败，请重试")}.bind(this)})},onClickSaveTo:function(t){window._hmt.push(["_trackEvent","mobile","save-to"]),t.preventDefault(),this.$saveBtn=i(t.currentTarget);var n,o=e("util/State").getInstance(),s=o.get("note");if(s){var l=e("model/NoteCollection").getInstance();n=l.get(s)}else{var a=e("model/SharedNoteModel");n=a.getModel()}this.showSaveDialog(n)},onClickDownload:function(){window._hmt.push(["_trackEvent","mobile","download"])},onClickLogout:function(){window._hmt.push(["_trackEvent","mobile","logout"]),o.logout(),o.on("logoutSuccess",this.onLogoutSuccess,this),i("#copyToMyNote").children("button").html("").removeClass("inactive").addClass("active")},onClickCheck:function(e){e.preventDefault(),n.showPopTips("添加到我的笔记后,可以编辑待办事项")},onClickPraise:function(e,t){var t=i(e.currentTarget);t.hasClass("clicked")||(window._hmt.push(["_trackEvent","mobile","praise","praise-note"]),i.ajax({type:"POST",url:"/yws/public/note/"+this.model.shareKey+"?method=praise",success:function(){t.addClass("clicked"),i(".note-praise").html(this.model.attributes.praise+1),s.set("praise-"+this.model.id,!0)}.bind(this),error:function(){window._hmt.push(["_trackEvent","mobile","praise-fail","praise-note"])}}))},resizeObject:function(){var e=this.$div.get(0),t=function(){this.$div.find("img").each(function(e,t){var n=i(t),o=this.$div.width(),s=n.width(),l=n.offset();if(s>o){var a=o/s;n.css({width:o+"px",height:n.height()*a+"px"})}s=Math.min(s,o),l.left+s>o&&n.css("display","block")}.bind(this))}.bind(this);e.scrollWidth>e.clientWidth&&t()},onSaveSuccess:function(){this.$saveBtn.html("保存成功"),n.showPopTips("已保存至默认笔记本")},onSaveFail:function(){n.showPopTips("保存失败")},onLogoutSuccess:function(){i("#logoutUser").hide(),n.showPopTips("注销成功")}}),c=null;return{getInstance:function(){return null===c&&(c=new r),c}}}),define("util/PopTips",["lib/jquery","util/UserAgent"],function(e,t){var i=e("lib/jquery"),n='<div class="popTips">{{message}}</div>',o='<div class="wx-mask"></div><div class="wx-pop-tips">{{message}}</div>',s=e("util/UserAgent"),l=function(e,t){return t.replace(/\{\{(\w*)\}\}/gm,function(t,i){return e[i]})};t.showPopTips=function(e){var t={message:e},o=l(t,n);i(".tips").html(o),i(".popTips").fadeIn(1e3),setTimeout(function(){i(".popTips").fadeOut(1e3)},2e3)},t.showWxTips=function(){var e=s.isIOS?"在Safari中打开":"在浏览器中打开",t={message:"请点击该按钮， 选择“"+e+"”，即可下载"},n=l(t,o);i(".wx-tips").html(n),i(".wx-tips").show(),i(".wx-tips").on("click",function(){i(".wx-tips").hide()})},t.setPopTips=function(){i("body").append('<div class="tips"></div>')},t.setWxTips=function(){i("body").append('<div class="wx-tips"></div>')}}),define("model/UserModel",["lib/underscore","lib/backbone","lib/jquery","util/Api","util/Cookie","util/State","model/StateModel","model/BaseModel","util/UserAgent","util/Dispatch"],function(e){var t=e("lib/underscore"),i=e("lib/backbone"),n=e("util/Api").UserData,o=e("util/Cookie"),s=e("lib/jquery"),l=t.extend({},i.Events,{LOOP_TIME:100,YNOTE_AUTH_COOKIE_NAME:"YNOTE_LOGIN",isURSPersisLogin:!1,isURSLogin:!1,userInfo:null,userMeta:null,logout:function(){var e=n.logout;s.ajax({url:e,success:function(e){e.urs?this.logoutUrs():this.trigger("logoutSuccess")}.bind(this),cache:!1,type:"GET"})},prepareURSPersistLogin:function(e){this.isURSPersisLogin=e},logoutUrs:function(){$iframe=s('<iframe name="logoutIframe" width="0" height="0"></iframe'),$iframe.on("load",function(){o.get("S_INFO")||(this.trigger("logoutSuccess"),$iframe.remove())}.bind(this)),$iframe.attr("src",n.ursLogout),$iframe.appendTo(document.body)},getUserName:function(){return this.userInfo?this.userInfo.name:null},getUserDefaultNotebook:function(){return this.userMeta?["/",this.userMeta.df].join(""):null},exchangeCookie:function(){if(o.get("S_INFO")){var e=n.ursAuth;e=this.isURSPersisLogin?e+"&pe=1":e,s.when(s.ajax({type:"GET",url:e,dataType:"json",cache:!1}),s.ajax({type:"get",url:n.userMeta,cache:!1})).done(function(e){this.userInfo=e[0],this.isURSLogin=!0,this.trigger("loginSuccess",this),this.trigger("ursLoginSuccess")}.bind(this))}},ursLoginFrameHandler:function(){o.get("S_INFO")?this.exchangeCookie():this.trigger("ursLoginFailed")},ursLogoutFrameHandler:function(){},authCookieMonitor:function(){o.get(this.YNOTE_AUTH_COOKIE_NAME)?s.when(s.ajax({type:"get",url:n.userInfo,cache:!1,dataType:"json"}),s.ajax({type:"get",url:n.userMeta,cache:!1})).done(function(e){this.userInfo=e[0].user,this.isURSLogin=!1,this.trigger("loginSuccess",this)}.bind(this)):this.timer=setTimeout(this.authCookieMonitor.bind(this),this.LOOP_TIME)},startAuthCookieMonitor:function(){this.timer&&clearTimeout(this.timer),this.authCookieMonitor()},stopAuthCookieMonitor:function(){clearTimeout(this.timer)},getUserNotebooks:function(e){e=e||{},s.ajax({url:n.notebook,type:"GET",dataType:"json",cache:!1,success:function(){t.isFunction(e.success)&&e.success.apply(null,arguments)},error:function(i){500===i.status&&"207"===i.getResponseHeader("RES-CODE")?t.isFunction(e.authFail)&&e.authFail.apply(null,arguments):t.isFunction(e.error)&&e.error.apply(null,arguments)}})},saveToUserNotebook:function(i,o,l,a){a=a||{};var r=e("util/State").getInstance(),c=r.get("id"),u=n.copyNote,d=["shareKey=",c,"&p=",i,"&nb=",o,"&tl=",l].join(""),h=a.success,p=a.error,m=function(){this.trigger("saveSuccess"),t.isFunction(h)&&h.apply(null,arguments)}.bind(this),v=function(e){this.trigger("saveFail",e),t.isFunction(p)&&p.apply(null,arguments)}.bind(this);s.ajax({url:u,data:d,type:"POST",success:m,error:v,cache:!1})},fetchUserInfo:function(e){e=e||{};var i=function(i){this.userInfo&&this.userInfo.uid!==i.user.uid&&(this.isUserChanged=!0),this.userInfo=i.user,this.isUserChanged||!this.userMeta?this.fetchUsermeta(e):t.isFunction(e.success)&&e.success.apply(null,arguments)}.bind(this);s.ajax({url:n.userInfo,type:"get",cache:!1,dataType:"json",success:i})},fetchUsermeta:function(e){e=e||{};var i=function(i){this.userMeta=i,t.isFunction(e.success)&&e.success.apply(null,arguments)}.bind(this),o=function(){t.isFunction(e.error)&&e.error.apply(null,arguments)};s.ajax({url:n.userMeta,type:"get",dataType:"json",success:i,error:o,complete:e.complete,cache:!1})},persistLogin:function(){var e=function(e){this.userInfo=e}.bind(this),t=function(){s.ajax({type:"get",url:n.userInfo,success:e,cache:!1,dataType:"json"})}.bind(this);s.ajax({url:n.ursAuth,type:"get",success:t,cache:!1})}});return l}),define("util/Api",["lib/underscore"],function(e){var t={SharedResource:{notebook:"/yws/public/notebook/%shareKey?keyfrom=public",note:"/yws/public/note/%shareKey?keyfrom=public",content:"/yws/public/note/%shareKey/%fileId?keyfrom=public",alias:{path:"p",depth:"dp",thinMode:"th",digestNumber:"dn",withThumb:"thm",thumbThreshold:"thrh",title:"tl",version:"v",isDirectory:"dr",isDeleted:"del",createTime:"ct",modifyTime:"mt",tags:"tg",length:"sz",noteNumber:"nn",author:"au",sourceUrl:"su",thumbUrl:"thmurl",property:"pp",notebookTitle:"nbtl",digest:"dg",resourceNumber:"resnum",resourceSize:"ressize",pathList:"ps",baseVersion:"bv",threshold:"thr",fileId:"fid",size:"sz",destination:"dst",byteStream:"content",pv:"pv",praise:"pr"}},UserData:{notebook:"/yws/mapi/filemeta?method=get&keyfrom=public&dp=1&v=-1",ursAuth:"/auth/urs/login.json?app=web",userInfo:"/auth/cq.json?app=web",copyNote:"/yws/mapi/share?method=copy&keyfrom=public",logout:"/auth/reset?app=web",userMeta:"/yws/mapi/user?method=get&keyfrom=public",ursLogout:"http://account.youdao.com/logout?back_url="+encodeURIComponent("http://note.youdao.com/share/blank.html")},LogReport:{put:"/yws/mapi/ilogrpt?method=put&keyfrom=public"}},i=e("lib/underscore");
return i.each(t,function(e){if(e.alias){var t={};i.each(e.alias,function(e,i){t[e]=i}),e.aliasReverse=t}}),t}),define("util/Cookie",[],function(e,t){function i(e,t,i){var n=null;if(arguments.length>1&&(null===t||"object"!=typeof t)){if(i=jQuery.extend({},i),null===t&&(i.expires=-1),"number"==typeof i.expires){var o=i.expires,s=i.expires=new Date;s.setDate(s.getDate()+o)}return n=[encodeURIComponent(e),"=",i.raw?t+"":encodeURIComponent(t+""),i.expires?"; expires="+i.expires.toUTCString():"",i.path?"; path="+i.path:"",i.domain?"; domain="+i.domain:"",i.secure?"; secure":""].join(""),document.cookie=n,n}i=t||{};var l=function(e){return e};return i.raw||(l=decodeURIComponent),n=RegExp("(?:^|; )"+encodeURIComponent(e)+"=([^;]*)").exec(document.cookie),n?l(n[1]):null}t.get=function(e){return i(e)},t.set=i,t.remove=function(e,t){return i(e,null,t)}}),define("util/localStorage",[],function(){var e=window.localStorage;if(e)return{get:function(t){return unescape(e.getItem(t))},set:function(t,i){e.setItem(t,escape(i))},del:function(t){e.removeItem(t)},clear:function(){e.clear()},getAll:function(){var t,i=e.length,n=null,o=[];for(t=0;i>t;t++)n=e.key(t),o.push(n+"="+this.getKey(n));return o.join("; ")}};if(window.ActiveXObject){var t=document.documentElement,i="localstorage";try{t.addBehavior("#default#userdata"),t.save("localstorage")}catch(n){}return{set:function(e,n){t.setAttribute(e,n),t.save(i)},get:function(e){return t.load(i),t.getAttribute(e)},del:function(e){t.removeAttribute(e),t.save(i)}}}return{get:function(e){var t,i=document.cookie.split("; "),n=i.length,o=[];for(t=0;n>t;t++)if(o=i[t].split("="),e===o[0])return unescape(o[1]);return null},set:function(e,t,i){i=new Date,i.setDate(i.getDate()+1),document.cookie=e+"="+escape(t)+"; expires="+i.toGMTString()},del:function(e){document.cookie=e+"=''; expires=Fri, 31 Dec 1999 23:59:59 GMT;"},clear:function(){var e,t=document.cookie.split("; "),i=t.length,n=[];for(e=0;i>e;e++)n=t[e].split("="),this.deleteKey(n[0])},getAll:function(){return unescape(""+document.cookie)}}}),define("template/AppButton",["util/Template","lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("util/Template"),i={};return i.tpl='<div class="note-count {{countHide}}">\n    <span class="note-pv">阅读数 <span class="pv-num">{{notePv}}</span> 次</span>\n    <i class="icon praise-icon{{#clicked}} clicked{{/clicked}}"></i><span class="note-praise">{{praiseNum}}</span>\n</div>\n\n{{^isAd}}\n<p class="bottom-pr {{countHide}}">\n    <span class="recommend">推荐</span>\n    <span class="bottom-pr-link"><span class="ad"></span></span>\n</p> \n{{/isAd}}\n\n{{^isNotebook}}\n<p class="app-section">\n    <a href="javascript:;" target="_blank"  id="copyToMyNote"><button class="active"></button></a>\n</p>\n{{/isNotebook}}\n\n<p class="app-section">\n    <a href="http://a.app.qq.com/o/simple.jsp?pkgname=com.youdao.note&g_f=992216" target="_blank" id="downloadBtn"><button></button></a>\n</p>\n\n{{#isLogin}}\n<p class="app-section">     \n    <a href="javascript:;" target="_blank" id="logoutUser"><button>退出当前帐号</button></a>\n</p>\n{{/isLogin}}',new t(i.tpl)}),define("model/NoteCollection",["model/BaseCollection","lib/backbone","lib/underscore","lib/jquery","model/SharedNoteModel","model/BaseModel","util/Api","util/State","model/StateModel","util/UserAgent","util/Dispatch"],function(e){var t=e("model/BaseCollection"),i=e("model/SharedNoteModel"),n=e("util/Api").SharedResource,o=t.extend({model:i,url:n.notebook,totalLength:0,title:"",initialize:function(){t.prototype.initialize.apply(this,arguments),this.state=e("util/State").getInstance(),this.state.setNoteCollection(this),this.shareKey=this.state.get("id")},getTotalLength:function(){return this.totalLength},isHasUnloadedItem:function(){return this.length<this.totalLength},parse:function(e,i){return this.totalLength=e[0],this.title=e[1],e=e[2],t.prototype.parse.call(this,e,i)},fetch:function(i){this.trigger("fetchStart");var n=e("lib/underscore");i=i||{},i.url=this.url.replace(/%shareKey/,this.shareKey);var o=i.success;delete i.success,i=n.extend({success:function(){this.trigger("fetchEnd"),o&&o.apply(this,arguments)}.bind(this)},i),t.prototype.fetch.call(this,i)}}),s=null;return{getInstance:function(){return null===s&&(s=new o),s}}}),define("model/BaseCollection",["lib/backbone","lib/underscore","lib/jquery"],function(e){var t=e("lib/backbone");e("lib/underscore");var i=t.Collection.extend({});return i}),define("model/SharedNoteModel",["model/BaseModel","lib/backbone","lib/underscore","lib/jquery","util/Api","util/State","model/StateModel","model/BaseModel","util/UserAgent","util/Dispatch"],function(e){var t=e("model/BaseModel"),i=e("util/Api"),n=e("lib/backbone");e("lib/underscore"),e("lib/jquery");var o=t.extend({defaults:{byteStream:"",title:"无标题笔记"},api:i.SharedResource,idAttribute:"path",initialize:function(){t.prototype.initialize.apply(this,arguments);var i=e("util/State").getInstance();this.shareKey=i.get("id")},isNew:function(){return!1},parse:function(i){var n=e("lib/underscore");return n.isArray(i)&&(i=i[0]),i=t.prototype.parse.apply(this,arguments)},getFid:function(){var e=this.get("path");return e.substr(e.lastIndexOf("/")+1)},getSharedURL:function(){var t=e("util/State").getInstance(),i=t.get("type"),n=null;switch(i){case"note":n=this.api.note.replace(/%shareKey/,this.shareKey);break;case"notebook":n=this.api.content.replace(/%shareKey/,this.shareKey),n=n.replace(/%fileId/,this.getFid());break;default:throw"NOT SUPPORT PARAMTER"}return n},fetch:function(e){e.url=this.getSharedURL(),n.Model.prototype.fetch.call(this,e)}}),s=null;return o.setModel=function(e){s=e},o.getModel=function(){return s},o}),define("view/NavView",["lib/backbone","lib/underscore","lib/jquery","util/UserAgent","template/Nav","util/Template","lib/mustache","util/DateUtil","util/State","model/StateModel","model/BaseModel","util/Dispatch","view/Dialog/SaveToDialogView","view/DialogView","template/Dialog","template/SaveToDialog","model/UserModel","util/Api","util/Cookie","view/SaveToTipsView","template/SaveToTips","view/Dialog/LoginDialogView","template/LoginDialog","template/LoginTips","util/Passport","model/NoteCollection","model/BaseCollection","model/SharedNoteModel"],function(e){var t=e("lib/backbone"),i=e("util/UserAgent");e("lib/underscore"),e("lib/jquery");var n="1207",o=t.View.extend({id:"nw_head_menu",events:{"click #copyToMyNote":"onClickSaveTo","click .download-note-btn":"onClickDownloadBtn","click .focus-weibo":"onClickWeiboBtn","click .focus-wechat":"onClickWechatBtn","click .wechat-close":"onClickWechatClose","click .wechat-popup":"onClickWechatClose"},template:e("template/Nav"),render:function(){var t=this.$el;this.state=e("util/State").getInstance();var o="note"===this.state.get("type")?!0:!1;this.el.innerHTML=this.template.render({isMobile:i.isMobile,isSingleNote:o,isAd:window.abTest}),window.abTest&&(window.yd_slot_id=n,t.find(".ad").attr("id","yd_slot_id_"+n),setTimeout(function(){var e=document.createElement("script");e.src="http://impservice.union.youdao.com/imp/js/commonAd.js",t.find(".top-pr-link").append(e)},100))},showSaveDialog:function(t){var i=e("view/Dialog/SaveToDialogView").getInstance(),n=e("view/Dialog/LoginDialogView").getInstance(),o=e("model/UserModel");o.getUserNotebooks({success:function(e){o.fetchUserInfo({success:function(){n.hide(),i.setNotebooks(e.filter(function(e){return 0===e.del&&"/"!==e.p})),i.setModel(t),i.render(),i.show()}})}.bind(this),authFail:function(){o.off("loginSuccess"),o.on("loginSuccess",function(){this.showSaveDialog(t),o.off("loginSuccess")}.bind(this)),n.show()}.bind(this),error:function(){}.bind(this)})},onClickSaveTo:function(t){t.preventDefault();var i,n=e("util/State").getInstance(),o=n.get("note");if(o){var s=e("model/NoteCollection").getInstance();i=s.get(o)}else{var l=e("model/SharedNoteModel");i=l.getModel()}this.showSaveDialog(i)},onClickDownloadBtn:function(e){e.preventDefault(),window.open("http://note.youdao.com/download.html?auto=1")},onClickWeiboBtn:function(e){e.preventDefault(),window.open("http://weibo.com/youdaonote")},onClickWechatBtn:function(e){e.preventDefault(),this.$el.find(".wechat-popup").show()},onClickWechatClose:function(e){e.preventDefault(),this.$el.find(".wechat-popup").hide()}});return o}),define("template/Nav",["util/Template","lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("util/Template"),i={};return i.tpl='<div class="top-main">\n    <div class="top-logo">\n        <a href="/?auto=1" title="有道云笔记" class="ynote-logo" target="_blank"></a>\n    </div>\n    {{#isMobile}}\n    {{#isSingleNote}}\n    {{#isAd}}\n    <span class="top-pr-link"><span class="ad"></span>\n    {{/isAd}}\n    {{/isSingleNote}}\n    {{/isMobile}}\n\n    {{^isMobile}}\n    <div class="top-u-panel">\n        {{^isSingleNote}}\n        <div class="download-note-btn">\n            <i></i>\n            <span>下载有道云笔记</span>\n        </div>\n        {{/isSingleNote}}\n\n        <div class="focus-btn focus-weibo">\n            <i></i>\n            <span>关注官方微博</span>\n        </div>\n        <div class="focus-btn focus-wechat">\n            <i></i>\n            <span>关注官方微信</span>\n        </div>\n    </div>\n\n    {{#isSingleNote}}\n    <div class="blk-sidebar">\n        <div class="copy-note-btn" id="copyToMyNote">\n            <i></i>\n            <span>添加到我的笔记</span>\n        </div>\n        <div class="download-note-btn">\n            <i></i>\n            <span>下载有道云笔记</span>\n        </div>\n    </div>\n    {{/isSingleNote}}\n\n    {{^isSingleNote}}\n    <div class="blk-sidebar">\n        <div class="copy-note-btn" id="copyToMyNote">\n            <i></i>\n            <span>添加到我的笔记</span>\n        </div>\n    </div>\n    {{/isSingleNote}}\n\n    <div class="wechat-popup">\n        <div class="wechat-close">&nbsp;\n        </div>\n    </div>\n    {{/isMobile}}\n    \n    <hr class="top-btm-hr" />\n</div>',new t(i.tpl)}),define("view/Dialog/SaveToDialogView",["lib/jquery","lib/underscore","view/DialogView","lib/backbone","template/Dialog","util/Template","lib/mustache","util/DateUtil","template/SaveToDialog","model/UserModel","util/Api","util/Cookie","util/State","model/StateModel","model/BaseModel","util/UserAgent","util/Dispatch","view/SaveToTipsView","template/SaveToTips"],function(e){var t=e("lib/jquery"),i=e("lib/underscore"),n=e("view/DialogView"),o=n.extend({contentTemplate:e("template/SaveToDialog"),events:i.extend({},n.prototype.events,{"click .yes-button":"onClickYes","click .no-button":"onClickNo","click .dialog-top-logout:not(.disabled)":"onClickLogout"}),initialize:function(){n.prototype.initialize.apply(this,arguments),this.userModel=e("model/UserModel"),this.userModel.on("logoutSuccess",this.onLogoutSuccess,this),this.userModel.on("logoutFailed",this.onLogoutFailed,this),this.tipsView=e("view/SaveToTipsView").getInstance()},getRenderData:function(){var e=this.userModel.getUserDefaultNotebook(),t=this.notebooks.map(function(t){return t.p===e&&(t.isDefault=!0),t}),i=this.contentTemplate.render({notebooks:t,title:this.model.get("title"),username:this.userModel.getUserName(),userDefault:e});return{title:"保存到我的笔记",content:i}},setModel:function(e){this.model=e},setNotebooks:function(e){this.notebooks=e},render:function(){n.prototype.render.call(this,arguments),this.$el.width(400).css({top:"30%",left:"50%",marginLeft:"-200px"})},getSelectedNotebook:function(){return this.$("select").val()},getTitle:function(){return this.$("input.title").val().trim()||"无标题笔记"},resetUserTip:function(){this.$("dialog-top-logout").removeClass("disabled"),this.$("dialog-top-logout").html("更换用户")},onClickNo:function(){this.hide()},onClickYes:function(){this.hide();var t=e("model/UserModel");t.saveToUserNotebook(this.model.id,this.getSelectedNotebook(),this.getTitle())},onClickLogout:function(e){$target=t(e.currentTarget),this.userModel.logout(),$target.addClass("disabled"),$target.html("正在退出..")},onLogoutSuccess:function(){this.resetUserTip(),this.hide(),t("#copyToMyNote").click()},onLogoutFailed:function(){this.resetUserTip()}}),s=null;return{getInstance:function(){return null===s&&(s=new o),s}}}),define("view/DialogView",["lib/backbone","lib/underscore","lib/jquery","template/Dialog","util/Template","lib/mustache","util/DateUtil"],function(e){var t=e("lib/backbone"),i=e("lib/jquery"),n=e("lib/underscore"),o=t.View.extend({className:"dialog",events:{"click .dialog-close":"onDialogCloseClick"},template:e("template/Dialog"),initialize:function(){},getRenderData:function(){return{}},render:function(){this.el.innerHTML=this.template.render(this.getRenderData()),this.$mask=i("<div></div>",{"class":"dialog-mask"})},destroy:function(){this.$el.empty(),this.$mask.remove(),this.$mask=null},show:function(){this.trigger("beforeShow",this),i(document.body).append(this.$mask).append(this.$el),this.$el.find("input.text")[0],n.delay(function(){this.$el.addClass("dialog-open")}.bind(this),25)},hide:function(){this.$mask.detach(),this.$el.removeClass("dialog-open"),this.$el.detach(),this.trigger("afterHide",this)},onDialogCloseClick:function(e){e.preventDefault(),this.hide(),this.trigger("cancel")},onSubmitForm:function(e){return e.preventDefault(),!1}});return o}),define("template/Dialog",["util/Template","lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("util/Template"),i={};return i.tpl='<div class="dialog-inner">\n    <div class="dialog-hd">\n        <span class="dialog-title">{{title}}</span>\n        <a class="dialog-close">x</a>\n    </div>\n    <div class="dialog-bd">\n        {{{content}}}\n    </div>\n</div>\n',new t(i.tpl)}),define("template/SaveToDialog",["util/Template","lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("util/Template"),i={};return i.tpl='<div class="form dialog-form save">\n    <div class="dialog-top-tip">\n        <i class="ico dialog-top-tip-arrow"></i>\n        <div class="user-tip"><span class="user-label">当前登录用户为: {{username}}</span><a class="dialog-top-logout clickable">更换用户</a></div>\n    </div>\n    <div class="row" style="display:none">\n        <div class="row-hd"><label for="tl">标&nbsp;&nbsp;&nbsp;&nbsp;题:</label></div>\n        <div class="row-bd save-title">\n            <input type="text" class="text title" value="{{title}}" />\n        </div>\n    </div>\n\n    <div class="row">\n        <div class="row-hd"><label for="notebook">笔记本:</label></div>\n        <div class="row-bd">\n            <select value="{{userDefault}}">\n                {{#notebooks}}\n                <option value="{{p}}" {{#isDefault}}selected{{/isDefault}}>{{tl}}</option>\n                {{/notebooks}}\n            </select>\n        </div>\n    </div>\n\n    <div class="row indent-row dialog-btns">\n        <a class="btn blue-btn yes-button">保 存</a>\n        <a class="btn no-button">取 消</a>\n    </div>\n</div>\n\n',new t(i.tpl)}),define("view/SaveToTipsView",["lib/backbone","lib/underscore","lib/jquery","template/SaveToTips","util/Template","lib/mustache","util/DateUtil","model/UserModel","util/Api","util/Cookie","util/State","model/StateModel","model/BaseModel","util/UserAgent","util/Dispatch"],function(e){var t=e("lib/backbone");e("lib/jquery");var i=t.View.extend({template:e("template/SaveToTips"),defaultTimeout:5e3,className:"save-tips",initialize:function(){this.model=e("model/UserModel"),this.model.on("saveSuccess",this.onSaveSuccess,this),this.model.on("saveFail",this.onSaveFail,this)},showTips:function(e){if(e=e||{},!e.text)throw"INVALID_PARAMETER";this.renderOptions=e,this.render(),this.show();var t=e.time||this.defaultTimeout;this.timer=setTimeout(this.hide.bind(this),t)},show:function(){clearTimeout(this.timer),this.$el.appendTo(document.body)},render:function(){this.$el.html(this.template.render(this.renderOptions))},hide:function(){this.$el.detach()},onSaveSuccess:function(){this.showTips({text:"保存成功!"})},onSaveFail:function(){this.showTips({icon:"fail",text:"失败了.."})}}),n=null;return{getInstance:function(){null===n&&(n=new i)}}}),define("template/SaveToTips",["util/Template","lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("util/Template"),i={};return i.tpl='{{#icon}}\n<i class="save-ico save-ico-{{icon}}"></i>\n{{/icon}}\n{{#text}}\n{{text}}\n{{/text}}\n',new t(i.tpl)}),define("view/Dialog/LoginDialogView",["lib/jquery","lib/underscore","view/DialogView","lib/backbone","template/Dialog","util/Template","lib/mustache","util/DateUtil","template/LoginDialog","template/LoginTips","model/UserModel","util/Api","util/Cookie","util/State","model/StateModel","model/BaseModel","util/UserAgent","util/Dispatch","util/Passport"],function(e){var t=e("lib/jquery"),i=e("lib/underscore"),n=e("view/DialogView"),o=n.extend({contentTemplate:e("template/LoginDialog"),tipsTemlate:e("template/LoginTips"),hint:"163,126邮箱可直接登录",events:i.extend({},n.prototype.events,{'submit [name="loginForm"]':"onSubmit","mouseover .login-savelogin":"onSaveLoginMouseover","mouseout .login-savelogin":"onSaveLoginMouseout","click .login-tweibo":"onClickOAuthLogin","click .login-qq":"onClickOAuthLogin","click .login-tqq":"onClickOAuthLogin",'focus input[name="username"]':"onFocusUsername",'keydown input[name="username"]':"onKeydownUsername"}),initialize:function(){n.prototype.initialize.apply(this,arguments),this.userModel=e("model/UserModel"),this.userModel.on("ursLoginFailed",this.onUrsLoginFailed,this),this.userModel.on("ursLoginSuccess",this.onUrsLoginSuccess,this),this.userModel.on("loginSuccess",this.onLoginSuccess,this),this.render()},render:function(){n.prototype.render.apply(this,arguments),this.$("iframe").on("load",this.onActionLoad.bind(this)),this.renderTips();var t=e("util/Passport");t.bind(this.$('[name="username"]')[0]),this.$el.width(350).css({top:"30%",left:"50%",marginLeft:"-200px"})},getRenderData:function(){var e=this.contentTemplate.render();return{content:e,title:"登录到我的笔记"}},renderTips:function(){this.$tips=t(this.tipsTemlate.render().replace(/\r|\n|\t/g,"")),this.$persistWarning=t(this.$tips[0]),this.$validWarning=t(this.$tips[1]),this.$passport=t(this.$tips[2]),this.$tips.find(".login-tiparea-close").on("click",function(e){t(e.currentTarget).parent().hide()}),this.$tips.hide().appendTo(document.body)},show:function(){this.$('[name="username"]').val(""),this.$('[name="password"]').val(""),this.$('[name="savelogin"]').attr("checked",!1),n.prototype.show.apply(this,arguments),this.$('[name="username"]').focus()},hide:function(){n.prototype.hide.apply(this,arguments),this.$tips.hide()},showPersistLoginWarning:function(){var e=this.$(".login-savelogin"),t=e.offset();this.$persistWarning.show(),this.$persistWarning.offset({top:t.top+e.height()+3,left:t.left-40})},hidePersistLoginWarning:function(){this.$persistWarning.hide()},showValidWarning:function(){var e=this.$('[name="username"]').offset();this.$validWarning.show(),this.$validWarning.offset({top:e.top-116,left:e.left})},hideValidWaring:function(){this.$validWarning.hide()},valid:function(){var e=this.$('[name="username"]').val().trim(),t=this.$('[name="password"]').val().trim();return 1>e.length||1>t.length?!1:!0},onSubmit:function(e){return this.$('input[type="submit"]').hasClass("disabled-btn")?(e.preventDefault(),void 0):this.valid()?(this.$('input[type="submit"]').addClass("disabled-btn").val("正在登录.."),this.isStartLogin=!0,void 0):(this.showValidWarning(),e.preventDefault(),void 0)},onSaveLoginMouseover:function(){this.showPersistLoginWarning()},onSaveLoginMouseout:function(){this.hidePersistLoginWarning()},onActionLoad:function(){this.isStartLogin&&(this.isStartLogin=!1,this.userModel.ursLoginFrameHandler())},onClickOAuthLogin:function(){this.userModel.startAuthCookieMonitor()},onUrsLoginFailed:function(){this.showValidWarning(),this.$('input[type="submit"]').removeClass("disabled-btn").val("登录"),this.ursLoginFailed=!0},onUrsLoginSuccess:function(){this.$('input[type="submit"]').removeClass("disabled-btn").val("登录")},onFocusUsername:function(){this.hideValidWaring(),this.ursLoginFailed&&this.$('[name="password"]').val("")},onLoginSuccess:function(){this.userModel.stopAuthCookieMonitor()},onKeydownUsername:function(e){13===e.which&&this.$('[name="username"]').val().length&&(this.$('[name="password"]').focus(),e.preventDefault())}}),s=null;return{getInstance:function(){return null===s&&(s=new o),s}}}),define("template/LoginDialog",["util/Template","lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("util/Template"),i={};return i.tpl='<form class="form dialog-form login-form" action="https://reg.163.com/logins.jsp" name="loginForm" method="POST" target="loginIframe">\n    <input type="hidden" name="url" value="http://note.youdao.com/share/blank.html" />\n    <input type="hidden" name="type" value="1" />\n    <input type="hidden" name="product" value="note" />\n    <div class="row">\n        <div class="row-hd">\n            <label for="username">帐 户：</label>\n        </div>\n        <div class="row-bd">\n            <input type="text" class="text dialog-text" tabindex="10" name="username" autocomplete="off" class="login-default-text" defaultvalue="163,126邮箱可直接登录" />\n        </div>\n    </div>\n    <div class="row">\n        <div class="row-hd">\n            <label for="password">密 码：</label>\n        </div>\n        <div class="row-bd">\n            <input type="password" tabindex="11" class="text dialog-text password" name="password" />\n        </div>\n    </div>\n    <div class="row indent-row">\n        <div class="row-hd">&nbsp;</div>\n        <div class="row-bd">\n            <label for="savelogin" class="login-savelogin">\n                <input tabindex="13" type="checkbox" id="savelogin" name="savelogin" value="1" />\n                保存登录\n            </label>\n            &nbsp;&nbsp;&nbsp;&nbsp;\n            <label style="login-forget-label">\n                <a href="http://reg.163.com/getpasswd/RetakePassword.jsp" target="_blank">忘记密码</a>\n            </label>\n        </div>\n    </div>\n    <div class="row indent-row dialog-btns">\n        <input class="btn blue-btn" type="submit" value="登 录" />\n        &nbsp;&nbsp;&nbsp;&nbsp;\n        <a href="/auth/qq/cqq?app=web&f=true&pe=1" target="_blank" class="login-oauth login-qq">\n            <i class="ico ico-qq"></i>\n        </a>\n        <a href="/auth/tsina?app=web&pe=1" target="_blank" class="login-oauth login-tweibo">\n            <i class="ico ico-weibo"></i>\n        </a>\n        <a href="/auth/qq/wqq?app=web&f=true&pe=1" target="_blank" class="login-oauth login-tqq">\n            <i class="ico ico-tqq"></i>\n        </a>\n    </div>\n</form>\n<iframe name="loginIframe" class="hideIframe"></iframe>\n',new t(i.tpl)}),define("template/LoginTips",["util/Template","lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("util/Template"),i={};return i.tpl='<div class="remember_psw1" id="remember_psw">\n	<div class="login-tiparea-top"></div>\n	<a title="关闭" class="login-tiparea-close"></a>\n	<p>为了您的信息安全，请不要在网吧或公用电脑上使用此功能！</p>\n</div>\n<div class="login-tiparea" id="login_tiparea">\n	<p class="error-state">登录名或密码错误</p>\n	<p class="p-desc">1、通行证请输入邮箱全称</p>\n	<p class="p-desc2">163,126邮箱可直接登录</p>\n	<p class="p-desc">2、请检查邮箱地址及密码是否正确填写</p>\n	<a title="关闭" class="login-tiparea-close">关闭</a>\n	<div class="login-tiparea-bottom"></div>\n</div>\n<div id="passportusernamelist" class="domainSelector" style="display: none;">\n	<table width="100%" cellspacing=0 cellpadding=0>\n		<tr><td class="title">请选择或继续输入...</td></tr>\n		<tr><td>&nbsp;</td></tr>\n	</table>\n</div>\n',new t(i.tpl)}),define("util/Passport",["lib/jquery"],function(e){String.prototype.endsWith=function(e){var t=this.length-e.length;return t>=0&&this.lastIndexOf(e)===t};var t=function(e){for(var t=0,i=0;e;)i+=e.offsetLeft||0,t+=e.offsetTop||0,e=e.offsetParent;return{x:i,y:t}},i=navigator&&-1!=navigator.userAgent.toLowerCase().indexOf("msie"),n=function(){var o="163,126邮箱可直接登录",s=null,l=null,a=window.navigator.userAgent;a&&-1!=a.indexOf("iPad");var r=!0,c=-1,u=["163.com","126.com","yeah.net","vip.163.com","vip.126.com","popo.163.com","188.com","qq.com","yahoo.com.cn","sina.com"],d=null,h=function(e){return document.getElementById(e)},p=e("lib/jquery"),m=function(){for(var e=s.value.trim(),t=0;u.length>t;t++)if(e.endsWith(u[t]))return!0;return!1},v=function(e){e=e||window.event;var t=e.keyCode;if(n.suggestNames(),13==t){m()||N();var i=p(".password");i.length&&i.focus()}else n.suggestNames()},f=function(e){e=e||window.event;var t=e.keyCode;return 13==t?(S(e),!1):void 0},g=function(e){e=e||window.event;var t=e.keyCode;return 13==t?(S(e),!1):(r&&(r=!1,s.value.trim()==o&&(s.value="",s.style.color="#000000")),(38==t||40==t)&&(S(e),b(!0),k(38==t),b(!1)),void 0)},b=function(e){var t=w(c);if(t)try{t.style.backgroundColor=e?"white":"#D5F1FF"}catch(i){}},w=function(e){try{for(var t=l.firstChild.rows,i=0;t.length>i;++i)if(t[i].firstChild.idx==e)return t[i].firstChild}catch(n){}return!1},k=function(e){var t=c;if(null!=l.firstChild){var i=l.firstChild.rows;if(0!=i.length){var n;for(n=0;i.length>n&&i[n].firstChild.idx!=t;++n);c=e?0==n?i[i.length-1].firstChild.idx:i[n-1].firstChild.idx:n>=i.length-1?i[0].firstChild.idx:i[n+1].firstChild.idx}}},N=function(){if(T(d),""!=s.value.trim()){var e=w(c);e&&(s.value=e.innerHTML),b(!1)}},y=function(){d=h("passportusernamelist"),l=d.firstChild.rows[1].firstChild,c=0,s.onclick=function(){r&&s.value.trim()==o&&(r=!1,s.value="",s.style.color="#000000")},s.onfocus=function(){r||s.value.trim()!=o||(s.value="",s.style.color="#000000");try{window.showWarning1&&showWarning1(!1)}catch(e){}};var e=h("password_password")||h("password");if(e&&(e.onfocus=function(){try{window.showWarning1&&showWarning1(!1)}catch(e){}}),s.onblur=function(){var e=s.value.trim();if(""==e||e==o)return s.value=o,s.style.color="#bbbbbb",void 0;var t;if(0>(t=e.indexOf("@")))var i=e,n="";else var i=e.substr(0,t),n=e.substr(t+1,e.length);if(""==n)return s.value=i+"@"+u[c>0?c:0],T(d),void 0;for(var l=0;u.length>l;++l)if(n==u[l])return T(d),void 0;N()},s.addEventListener){var t=navigator.appVersion,i=t.match(/Konqueror|Safari|KHTML/)?"keydown":"keypress";s.addEventListener(i,g,!1),s.addEventListener("keyup",v,!1)}else s.attachEvent("onkeydown",g),s.attachEvent("onkeypress",f),s.attachEvent("onkeyup",v),window.attachEvent("onunload",function(){s=null,l=null,d=null})},S=function(e){e.cancelBubble=!0,e.returnValue=!1,e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()},T=function(e){e.style.display="none"},C=function(e){return document.createElement(e)};return{bind:function(e){s=e,y()},suggestNames:function(){var e=s.value.trim();if(""==e||-1!=e.indexOf("<")||-1!=e.indexOf(">"))return T(d),void 0;var n;if(0>(n=e.indexOf("@")))var o=e,a="";else var o=e.substr(0,n),a=e.substr(n+1,e.length);var r=[];if(""==a)for(var h=0;u.length>h;++h)r.push(o+"@"+u[h]);else for(var h=0;u.length>h;++h)0==u[h].indexOf(a)&&r.push(o+"@"+u[h]);if(0==r.length)return T(d),c=-1,void 0;var p=t(s),m=d.style;m.left=p.x-(i?1:0)+"px",m.top=p.y+s.offsetHeight-(i?1:0)+"px",m.width=s.offsetWidth-2+"px",m.zIndex="2000",m.paddingRight="0",m.paddingLeft="0",m.paddingTop="0",m.paddingBottom="0",m.backgroundColor="white",m.display="block";var v=C("TABLE");v.width="100%",v.cellSpacing=0,v.cellPadding=3;var f=C("TBODY");v.appendChild(f);for(var h=0;r.length>h;++h){var g=C("TR"),w=C("TD");w.nowrap="true",w.align="left",w.innerHTML=r[h],w.idx=h,w.onmouseover=function(){b(!0),c=this.idx,b(!1),this.style.cursor="pointer"},w.onmouseout=function(){},w.onclick=function(){N()},g.appendChild(w),f.appendChild(g)}l.innerHTML="",l.appendChild(v),b()}}}();return n}),define("view/NoteBookContainer",["lib/underscore","lib/backbone","lib/jquery","util/UserAgent","template/Home","util/Template","lib/mustache","util/DateUtil","model/NoteCollection","model/BaseCollection","model/SharedNoteModel","model/BaseModel","util/Api","util/State","model/StateModel","util/Dispatch","view/NavView","template/Nav","view/Dialog/SaveToDialogView","view/DialogView","template/Dialog","template/SaveToDialog","model/UserModel","util/Cookie","view/SaveToTipsView","template/SaveToTips","view/Dialog/LoginDialogView","template/LoginDialog","template/LoginTips","util/Passport","view/MobileNoteBook","util/PopTips","util/localStorage","template/NoteList","template/AppButton","template/RemindPanel","view/NoteContentView","template/NoteContent","template/NoteContentTitle","view/NoteContentInfoView","template/NoteContentInfo","view/FitSizeView","view/NoteListView","view/NoteList/SnapNoteListView","view/NoteList/BaseNoteListView","template/SnapNoteList","view/NoteList/SnapNoteView","view/NoteList/BaseNoteView","template/SnapNote","view/NavBack","template/NavBack","util/PathUtil","view/WebNoteBook","view/FitSizeView"],function(e){e("lib/underscore");var t=e("lib/backbone"),i=e("util/UserAgent");e("lib/jquery");var n=t.View.extend({template:e("template/Home"),className:"hide",initialize:function(){this.noteCollection=e("model/NoteCollection").getInstance();var t=e("view/NavView");this.nav=new t;var n=e("view/MobileNoteBook"),o=e("view/WebNoteBook");this.noteList=i.isMobile?n.getInstance({nav:this.nav}):o.getInstance(),this.noteList.setData(this.noteCollection),this.noteList.setCollection(this.notebookCollection),this.state=e("util/State").getInstance(),this.shareKey=this.state.get("id")||null},render:function(){this.renderCollection(),this.$el.addClass("list-note"),this.el.innerHTML=this.template.render({isMobile:i.isMobile,isSingleNote:!1}),this.$main=this.$(".blk-main"),this.nav.render(),this.$top=this.$(".blk-top"),this.$top.append(this.nav.el),this.$el.removeClass("hide"),this.$el.addClass("notebook")},renderCollection:function(){this.noteCollection.fetch({success:function(){document.title="分享的笔记本-"+this.noteCollection.title,this.$main.append(this.noteList.el),this.noteList.render(),e("view/FitSizeView").getInstance().fitSize(!0)}.bind(this),error:function(){e("util/Dispatch").To.error()}})}});return n}),define("view/MobileNoteBook",["lib/backbone","lib/underscore","lib/jquery","util/UserAgent","util/PopTips","model/UserModel","util/Api","util/Cookie","util/State","model/StateModel","model/BaseModel","util/Dispatch","util/localStorage","template/NoteList","util/Template","lib/mustache","util/DateUtil","template/AppButton","template/RemindPanel","view/NoteContentView","template/NoteContent","template/NoteContentTitle","view/NoteContentInfoView","template/NoteContentInfo","view/FitSizeView","view/NoteListView","view/NoteList/SnapNoteListView","view/NoteList/BaseNoteListView","template/SnapNoteList","view/NoteList/SnapNoteView","view/NoteList/BaseNoteView","template/SnapNote","view/NavBack","template/NavBack","util/PathUtil","model/NoteCollection","model/BaseCollection","model/SharedNoteModel"],function(e){var t=e("lib/backbone");e("lib/underscore");var i=e("lib/jquery"),n=e("util/UserAgent"),o=e("util/PopTips"),s=e("model/UserModel"),l="https://note.youdao.com/oauth/login_mobile.html",a=e("util/localStorage"),r="1213",c=t.View.extend({className:"blk-minor",events:{"click a":"setLinkOpenMode","click #copyToMyNote":"onClickSaveTo","click [data-path]":"onClickAttachment","click #logoutUser":"onClickLogout","click .remind-checked":"onClickCheck","click .remind-watch":"onClickCheck","click .ynote-back":"onClickBackToList","click .praise-icon":"onClickPraise"},defaultOptions:{},displayMode:1,template:e("template/NoteList"),appButtonTemplate:e("template/AppButton"),remindTemplate:e("template/RemindPanel"),initialize:function(t){this.nav=t.nav;var i=e("view/NoteContentView");this.note=i.getInstance();var n=e("view/NoteListView");this.noteList=n.getInstance();var s=e("view/NavBack");this.navBack=s.getInstance(),this.state=e("util/State").getInstance(),this.state.on("change:note",this.onNoteChange,this),this.note.on("modelLoaded",this.onNoteChange,this),o.setPopTips(),o.setWxTips()},render:function(){this.$el.append(this.navBack.$el),this.$notediv=i("<div></div>").addClass("blk-note-content"),this.$el.append(this.$notediv),this.$el.append(this.noteList.$el),this.$div=i("<div></div>").addClass("note-content-wrapper mobile-wrapper"),this.$el.append(this.$div),this.$navBack=this.$(".top-back"),this.$list=this.$(".blk-list"),this.$content=this.$(".blk-note-content"),i("#wrap").addClass("mobile-wrap"),this.$content.hide(),this.noteList.render(),this.appendButton()
},setData:function(e){this.collection=e,this.noteList.setListCollection(this.collection),this.noteList.setNoteContent(this.note.$el),this.note.setCollection(this.collection),this.navBack.setCollection(this.model)},setCollection:function(e){this.notebookCollection=e},setModel:function(e){this.model=e,this.note.setModel(this.model)},getNoteFromState:function(){var e=this.state.get("note");return this.collection.get(e)},onNoteChange:function(e,t){if(null===t||"note"===this.state.get("type"))return this.$el.hide(),void 0;var n,o=this.getNoteFromState();this.setModel(o),this.note.render(),this.openNoteDetail(),i(".note-count").removeClass("hide"),i(".bottom-pr").removeClass("hide"),i(".pv-num").html(this.model.toJSON().pv),i(".note-praise").html(this.model.toJSON().praise),n=a.get("praise-notebook-"+this.model.id),n="null"!=n&&"undefined"!=n&&n?!0:!1,n?i(".praise-icon").addClass("clicked"):i(".praise-icon").removeClass("clicked"),i(window).scrollTop(0)},openNoteDetail:function(){this.navBack.render(),this.$notediv.append(this.note.$el),this.$list.hide(),this.nav.$el.hide(),this.$navBack.show(),this.$content.show()},onClickBackToList:function(){this.$list.show(),this.$navBack.hide(),this.$content.hide(),i(".note-count").addClass("hide"),i(".bottom-pr").addClass("hide"),i(".praise-icon").removeClass("clicked"),this.nav.$el.show()},appendButton:function(){var e=this.$div;s.fetchUsermeta({success:function(){this.isLogin=!0,this.state.get("copy")&&i("#copyToMyNote .active").click()}.bind(this),error:function(){this.isLogin=!1}.bind(this),complete:function(){var t=this.$el;e.append(this.appButtonTemplate.render({countHide:"hide",isNotebook:!0,isLogin:this.isLogin,isAd:window.abTest})),window.abTest||(window.yd_slot_id=r,t.find(".ad").attr("id","yd_slot_id_"+r),setTimeout(function(){var e=document.createElement("script");e.src="http://impservice.union.youdao.com/imp/js/commonAd.js",t.find(".bottom-pr-link").append(e)},100))}.bind(this)})},setLinkOpenMode:function(t){var n=t.target,o="a"===n.tagName.toLowerCase()?i(n):i(n).parents("a");if(o.length>0){t.preventDefault();var s=e("util/PathUtil");s.isLink(o[0].href)&&window.open(o[0].href,"_blank")}},showSaveDialog:function(){s.getUserNotebooks({success:function(){this.$saveBtn.html("正在保存中..."),this.$saveBtn.addClass("inactive"),e("util/State").getInstance(),s.fetchUsermeta({success:function(){var e=this.model.id,t=s.getUserDefaultNotebook(),i=document.title;s.saveToUserNotebook(e,t,i),s.on("saveSuccess",this.onSaveSuccess,this),s.on("saveFail",this.onSaveFail,this)}.bind(this)})}.bind(this),authFail:function(){var e=location.href;this.state.get("copy")||(e+="&copy=click"),location.href=l+"?back_url="+encodeURIComponent(e)}.bind(this),error:function(){o.showPopTips("保存失败，请重试")}.bind(this)})},onClickAttachment:function(e){var t=e.currentTarget,i=t.getAttribute("data-path");navigator.userAgent,n.isWeixin?(e.preventDefault(),o.showWxTips()):i&&i.length&&(i=i+(-1===i.indexOf("?")?"?":"&")+"keyfrom=public",window.open(i))},onClickSaveTo:function(t){t.preventDefault(),this.$saveBtn=i(t.currentTarget);var n,o=e("util/State").getInstance(),s=o.get("note");if(s){var l=e("model/NoteCollection").getInstance();n=l.get(s)}else{var a=e("model/SharedNoteModel");n=a.getModel()}this.showSaveDialog(n)},onClickLogout:function(){s.logout(),s.on("logoutSuccess",this.onLogoutSuccess,this),i("#copyToMyNote").children("button").html("").removeClass("inactive").addClass("active")},onClickCheck:function(e){e.preventDefault(),o.showPopTips("添加到我的笔记后,可以编辑待办事项")},onClickPraise:function(e,t){var t=i(e.currentTarget);if(!t.hasClass("clicked")){window._hmt.push(["_trackEvent","mobile","praise","praise-notebook"]);var n=this.model.id.split("/")[2];i.ajax({type:"POST",url:"/yws/public/note/"+this.model.shareKey+"/"+n+"?method=praise",success:function(){t.addClass("clicked"),i(".note-praise").html(this.model.toJSON().praise+1),a.set("praise-notebook-"+this.model.id,!0)}.bind(this),error:function(){window._hmt.push(["_trackEvent","mobile","praise-fail","praise-notebook"])}})}},resizeObject:function(){var e=this.$div.get(0),t=function(){this.$div.find("img").each(function(e,t){var n=i(t),o=this.$div.width(),s=n.width(),l=n.offset();if(s>o){var a=o/s;n.css({width:o+"px",height:n.height()*a+"px"})}s=Math.min(s,o),l.left+s>o&&n.css("display","block")}.bind(this))}.bind(this);e.scrollWidth>e.clientWidth&&t()},onSaveSuccess:function(){this.$saveBtn.html("保存成功"),o.showPopTips("已保存至默认笔记本")},onSaveFail:function(){o.showPopTips("保存失败")},onLogoutSuccess:function(){i("#logoutUser").hide(),o.showPopTips("注销成功")}}),u=null;return{getInstance:function(e){return null===u&&(u=new c(e)),u}}}),define("template/NoteList",["util/Template","lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("util/Template"),i={};return i.tpl='<div class="blk-bd ">\n    <!--a href="#" id="prevNote"><i>上一篇</i></a>\n    <a href="#" id="nextNote"><i>下一篇</i></a-->\n\n    <div class="notebook-title fit-size-sibling">\n        <div class="notebook-title-text">{{shareTitle}}</div>\n        <div class="note-num">（包含 {{noteNum}} 篇笔记）</div>\n    </div>\n</div>\n',new t(i.tpl)}),define("view/NoteListView",["lib/backbone","lib/underscore","lib/jquery","template/NoteList","util/Template","lib/mustache","util/DateUtil","view/NoteList/SnapNoteListView","view/NoteList/BaseNoteListView","util/State","model/StateModel","model/BaseModel","util/UserAgent","util/Dispatch","template/SnapNoteList","view/NoteList/SnapNoteView","view/NoteList/BaseNoteView","template/SnapNote","view/FitSizeView"],function(e){var t=e("lib/backbone");e("lib/jquery"),e("lib/underscore");var i=t.View.extend({className:"blk-list",list:null,template:e("template/NoteList"),defaultOptions:{},displayMode:1,listView:null,collection:null,notebookCollection:null,initialize:function(){this.listView={}},initList:function(){var t=null,i=e("view/NoteList/SnapNoteListView");return t=new i({collection:this.collection})},render:function(){this.notebookCollection&&this.setCollection(this.notebookCollection),this.el.innerHTML=this.template.render({shareTitle:this.collection.title,noteNum:this.collection.length}),this.switchListMode(this.displayMode)},setListCollection:function(e){this.collection=e},setNoteContent:function(e){this.noteContent=e},renderList:function(){this.list.render(),this.list.resetList(),this.$el.find(".blk-bd").append(this.list.el)},switchListMode:function(t){var i=document.body.scrollLeft,n=document.body.scrollTop;window.onscroll=function(){window.scrollTo(i,n)},this.displayMode=t,this.list&&this.list.destroy(),this.list=this.initList(),this.renderList(),this.$el.removeClass("view-snap view-table fit-size-sibling"),this.$el.addClass("view-snap"),e("view/FitSizeView").getInstance().fitSize(!0),window.onscroll=null}}),n=null;return{getInstance:function(){return null===n&&(n=new i),n}}}),define("view/NoteList/SnapNoteListView",["view/NoteList/BaseNoteListView","lib/backbone","lib/underscore","lib/jquery","util/State","model/StateModel","model/BaseModel","util/UserAgent","util/Dispatch","template/SnapNoteList","util/Template","lib/mustache","util/DateUtil","view/NoteList/SnapNoteView","view/NoteList/BaseNoteView","template/SnapNote"],function(e){var t=e("view/NoteList/BaseNoteListView");e("lib/underscore");var i=t.extend({className:"list-wrp-snap fit-size",template:e("template/SnapNoteList"),createView:function(t){var i=e("view/NoteList/SnapNoteView");return new i({model:t,collection:this.collection})}});return i}),define("view/NoteList/BaseNoteListView",["lib/backbone","lib/underscore","lib/jquery","util/State","model/StateModel","model/BaseModel","util/UserAgent","util/Dispatch"],function(e){var t=e("lib/backbone"),i=e("lib/underscore"),n=e("lib/jquery"),o=t.View.extend({initialize:function(){this.notes={},this.collection.on("reset",this.onReset,this),this.collection.on("fetchStart",this.onFetchStart,this),this.collection.on("fetchEnd",this.onFetchEnd,this),this.collection.on("resetStart",this.onResetStart,this),this.state=e("util/State").getInstance(),this.state.on("change:note",this.onNoteChange,this)},destroy:function(){n(this.el).remove(),this.collection.off("reset",this.onReset),this.resetContent()},template:function(){},render:function(){this.el.innerHTML=this.template.render(),this.$list=this.$el,this.$loading=this.$(".loading-tip").detach(),this.$empty=this.$(".empty-tip").detach()},resetContent:function(){i.forEach(this.notes,function(e,t){e.destroy(),delete this.notes[t]},this)},createView:function(){throw"METHOD_MUST_IMPLEMENTS"},getNoteHeight:function(){throw"METHOD_MUST_IMPLEMENTS"},addNote:function(e){this.renderEmpty(!1);var t=this.createView(e);this.notes[e.id]=t,t.render();var i=this.collection.indexOf(e),n=this.$list.children().eq(i);n.length>0?n.before(t.el):this.$list.append(t.el)},resetList:function(){this.resetContent(),this.collection.forEach(this.addNote,this)},renderEmpty:function(e){e!==this.isEmptyShown&&(e&&!this.isEmptyShown?this.$empty.appendTo(this.$list):this.$empty.detach(),this.isEmptyShown=e)},onReset:function(){this.resetList()},onNoteChange:function(e,t){var i=this.$el.find(".note");i.filter("[active]").removeAttr("active"),i.filter('[data-note-id="'+t+'"]').attr("active","active")},onFetchStart:function(){this.$loading.appendTo(this.$list),this.resetContent()},onFetchEnd:function(){this.$loading.detach()},onResetStart:function(){this.resetContent()}});return o}),define("template/SnapNoteList",["util/Template","lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("util/Template"),i={};return i.tpl='<div class="empty-tip">\n    <h2>没有共享的笔记</h2>\n</div>\n<div class="loading-tip">\n    <img src="style/images/loading.gif" align="absmiddle"> 正在加载笔记……\n</div>\n',new t(i.tpl)}),define("view/NoteList/SnapNoteView",["view/NoteList/BaseNoteView","lib/backbone","lib/underscore","lib/jquery","util/UserAgent","util/State","model/StateModel","model/BaseModel","util/Dispatch","template/SnapNote","util/Template","lib/mustache","util/DateUtil"],function(e){var t=e("view/NoteList/BaseNoteView"),i=t.extend({className:"entry note",template:e("template/SnapNote"),getRenderData:function(){var e=t.prototype.getRenderData.apply(this,arguments);return e}});return i}),define("view/NoteList/BaseNoteView",["lib/backbone","lib/underscore","lib/jquery","util/UserAgent","util/State","model/StateModel","model/BaseModel","util/Dispatch"],function(e){var t=e("lib/backbone"),i=e("lib/jquery"),n=e("util/UserAgent"),o=t.View.extend({events:{click:"onClick"},initialize:function(){this.state=e("util/State").getInstance()},template:function(){},getRenderData:function(){var e=this.model.toJSON();return e.property.digest&&e.property.digest.length||e.property&&e.property.thumbUrl&&(e.property.thumbUrl+="?width=140"),e.title=e.title||"无标题笔记",e},render:function(){this.el.innerHTML=this.template.render(this.getRenderData()),this.el.setAttribute("data-note-id",this.model.id);var e=this.state.get("note");n.isMobile||(this.state.get("note")===this.model.id||!e&&this.model===this.model.collection.first())&&this.el.setAttribute("active","active")},destroy:function(){i(this.el).remove()},onClick:function(){this.state.set({note:this.model.id})},onModelChange:function(){this.render()}});return o}),define("template/SnapNote",["util/Template","lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("util/Template"),i={};return i.tpl='<div class="entry-media">\n    {{#property}}\n        {{#thumbUrl}}<img src="{{thumbUrl}}" class="media-img"/>{{/thumbUrl}}\n    {{/property}}\n</div>\n<div class="entry-bd">\n    <div class="entry-title" title="{{title}}">\n        <h2>{{title}}</h2>\n    </div>\n    <p class="entry-summary">\n    {{#property}}\n    {{digest}}\n    {{/property}}\n    </p>\n</div>\n<div class="entry-ft">\n    {{#property}}\n        {{#resourceNumber}}\n        <i class="ico ico-attachment"></i> ({{resourceNumber}}) \n        {{#_formatFileSize}}{{resourceSize}}{{/_formatFileSize}}\n        {{/resourceNumber}}\n    {{/property}}\n</div>\n',new t(i.tpl)}),define("view/NavBack",["lib/backbone","lib/underscore","lib/jquery","util/UserAgent","template/NavBack","util/Template","lib/mustache","util/DateUtil","util/State","model/StateModel","model/BaseModel","util/Dispatch"],function(e){var t=e("lib/backbone");e("util/UserAgent"),e("lib/underscore"),e("lib/jquery");var i="1207",n=t.View.extend({className:"top-back",template:e("template/NavBack"),render:function(){var t=this.$el;this.state=e("util/State").getInstance(),"note"===this.state.get("type")?!0:!1,this.el.innerHTML=this.template.render({isAd:window.abTest}),window.abTest&&(window.yd_slot_id=i,t.find(".ad").attr("id","yd_slot_id_"+i),setTimeout(function(){var e=document.createElement("script");e.src="http://impservice.union.youdao.com/imp/js/commonAd.js",t.find(".top-pr-link").append(e)},100))},setCollection:function(e){this.collection=e}}),o=null;return{getInstance:function(){return null===o&&(o=new n),o}}}),define("template/NavBack",["util/Template","lib/jquery","lib/mustache","lib/underscore","util/DateUtil"],function(e){var t=e("util/Template"),i={};return i.tpl='<div class="ynote-back" target="_blank">\n    <i></i>返回到笔记本\n</div>\n{{#isAd}}\n<span class="top-pr-link"><span class="ad"></span></span>\n{{/isAd}}',new t(i.tpl)}),define("util/PathUtil",[],function(e,t){t.dirname=function(e){return e.substr(e,e.lastIndexOf("/"))},t.isLink=function(e){var t=/^https?:\/\//;return Boolean(e&&t.test(e))},t.getArguments=function(){var e=window.location.search.replace(/^\?/,""),t=e.split("&"),i={};return t.forEach(function(e){var t=e.split("="),n=t[0],o=t[1]||null;i[n]=o}),i}}),define("view/WebNoteBook",["lib/backbone","lib/underscore","lib/jquery","view/NoteContentView","util/UserAgent","template/NoteContent","util/Template","lib/mustache","util/DateUtil","template/RemindPanel","template/NoteContentTitle","view/NoteContentInfoView","template/NoteContentInfo","util/State","model/StateModel","model/BaseModel","util/Dispatch","view/FitSizeView","view/NoteListView","template/NoteList","view/NoteList/SnapNoteListView","view/NoteList/BaseNoteListView","template/SnapNoteList","view/NoteList/SnapNoteView","view/NoteList/BaseNoteView","template/SnapNote"],function(e){var t=e("lib/backbone");e("lib/underscore");var i=e("lib/jquery"),n=t.View.extend({className:"blk-minor",initialize:function(){var t=e("view/NoteContentView");this.note=t.getInstance();var i=e("view/NoteListView");this.noteList=i.getInstance(),this.state=e("util/State").getInstance(),this.state.on("change:note",this.onNoteChange,this)},render:function(){this.$el.append(this.noteList.el),this.$div=i("<div></div>").addClass("blk-note-content"),this.$div.append(this.note.el),this.$el.append(this.$div),this.note.render(),this.noteList.render()},setData:function(e){this.collection=e,this.noteList.setListCollection(this.collection),this.noteList.setNoteContent(this.note.el),this.note.setCollection(this.collection)},setCollection:function(e){this.notebookCollection=e},setModel:function(e){e!==this.model&&(this.model=e,this.note.setModel(this.model))},getNoteFromState:function(){var e=this.state.get("note");return this.collection.get(e)},onNoteChange:function(e,t){if(null===t||"note"===this.state.get("type"))return this.$el.hide(),void 0;this.$el.show();var i=this.getNoteFromState();this.setModel(i)}}),o=null;return{getInstance:function(){return null===o&&(o=new n),o}}});